# patterns_hybrid_v14_final.yaml
#
# Optimiert für HAS CT-Avis Extraktion
# Version: V14 FINAL (Dezember 2025)
# 
# FINALE ÄNDERUNGEN:
# - Apostroph-Varianten vollständig: [''] deckt jetzt ', ', ' ab
# - Alle Patterns abgestimmt auf V14 Python-Code
# - Produktionsreif für französische HAS-Dokumente

options:
  # Überschriften, mit denen wir die Texte in Blöcke schneiden
  # FIX: L['']ESSENTIEL statt L['']ESSENTIEL
  start_heading: "(?mi)^(?:\\d{1,2}(?:\\.\\d{1,2}){0,3}[\\)\\.]?[ \\t]*)?(?:INDICATIONS? TH[ÉE]RAPEUTIQUES|INDICATIONS? DE L['']AMM|INDICATIONS?|POPULATION(?:\\s+CIBLE)?|PATIENTS? CONCERN[ÉE]S?|SOUS-?POPULATION|SOUS-?GROUPE|COMPARATEURS?(?:\\s+CLINIQUEMENT\\s+PERTINENTS)?|M[ÉE]DICAMENTS? DE COMPARAISON|DISCUSSION|ANALYSE|SYNTH[ÈE]SE|CONCLUSION|CONCLUSIONS? DE LA COMMISSION|L['']ESSENTIEL|SERVICE M[ÉE]DICAL RENDU|SMR|ASMR|POPULATION CIBLE)\\b"
  strip_whitespace: true


Indication:
  min_chars: 50
  max_length: 2000
  patterns:
    # GRUPPE A: PIS_INS/REEV/RI - Klassische CT-Avis
    - rule_id: indications_therapeutiques_section
      start: '(?mi)^\s*\d{2}[\s.]*INDICATIONS?\s+TH[ÉE]RAPEUTIQUES?\b'
      end: '(?mi)^\s*\d{2}[\s.]*(?:CONTEXTE|CONCLUSIONS?|RAPPEL|SERVICE\s+M[ÉE]DICAL|ENVIRONNEMENT|SYNTH[ÈE]SE|COMPARATEURS?|POPULATION\s+CIBLE)'
      min_chars: 80
      priority: 1
    
    # GRUPPE B: PIC_EI/AP - Contexte-Tableau
    - rule_id: indication_concernee_tableau
      start: '(?i)Indication\s+concern[ée]e\s+par\s+l[''']?[ée]valuation'
      end: '(?mi)^\s*(?:Posologie|Comparateurs?|Service\s+m[ée]dical|Population)'
      min_chars: 50
      priority: 1
    
    - rule_id: indication_amm_tableau
      start: '(?i)Indication\s+de\s+l[''']?AMM'
      end: '(?mi)^\s*(?:Posologie|Comparateurs?|Date\s+d[''']AMM)'
      min_chars: 50
      priority: 1
    
    # GRUPPE C: PIS_RCP - Kopftabelle
    - rule_id: indications_rcp_tableau
      start: '(?mi)^Indications?\s*$'
      end: '(?mi)^(?:Posologie|Contre-indications?|4\.[0-9]|Mises\s+en\s+garde)'
      min_chars: 40
      priority: 1
    
    # Fallback 1: Indication concernée(s) generisch
    - rule_id: indication_concernee_generic
      start: '(?i)Indication\(s\)\s+concern[ée]e\(s\)'
      end: '(?mi)^\s*(?:[A-Z]{4,}|Liste\s+des\s+sp[ée]cialit[ée]s)'
      min_chars: 50
      priority: 2
    
    # Fallback 2: AMM-Satz im Fließtext
    - rule_id: indication_amm_sentence
      start: '(?i)(?:L[''']indication\s+de\s+l[''']AMM|Indication\s+retenue)\s*:\s*[«"]'
      end: '[»"]'
      min_chars: 40
      priority: 3

      # 1) Tabellen-Felder (PIS, kurze CT-Avis, neues HAS-Layout 2025)
      # FIX: l[''] statt l['']
      - "(?mi)^\\s*Indication\\s+concern[ée]e?\\s+par\\s+l['']évaluation\\s*[:\\-]"
      - "(?mi)^\\s*Indication\\s+concern[ée]e?\\s*[:\\-]"
      - "(?mi)^\\s*Indication\\s+de\\s+l['']AMM\\s*[:\\-]"
      - "(?mi)^\\s*Indications?\\s+de\\s+l['']AMM\\s*[:\\-]"

      # 2) Abschnittsüberschriften mit Kapitelnummerierung (klassische CT-Avis)
      - "(?mi)^\\s*(?:\\d{1,2}(?:\\.\\d{1,2})?[\\)\\.]?\\s*)?INDICATIONS?(?:\\s+TH[ÉE]RAPEUTIQUES)?\\b"
      - "(?mi)^\\s*(?:\\d{1,2}[\\. \\t]*)?INDICATIONS?\\s+TH[ÉE]RAPEUTIQUES\\b"
      - "(?mi)^\\s*(?:\\d{1,2}[\\. \\t]*)?INDICATIONS?\\s+DE\\s+L['']AMM\\b"
      - "(?mi)^\\s*(?:\\d{1,2}[\\. \\t]*)?INDICATIONS?\\b"

      # 3) Fließtext-Patterns
      # FIX: l[''] statt l['']
      - "(?mi)\\bindication\\s+de\\s+l['']AMM\\b"
      - "(?mi)\\best indiqu[ée]e?\\b"
      
      # 4) AMM-Satz im Fließtext (für Generika/Kurz-Avis)
      - "(?mi)[^.]{0,150}\\best\\s+indiqu[ée]e?\\s+(?:dans|pour)\\s+le\\s+traitement\\b[^.]*\\."

  Population:
    min_chars: 40  # Gesenkt von 80 für Meta-Aussagen
    max_length: 1200
    patterns:
      # 1) Abschnittsüberschriften mit Kapitelnummerierung
      - "(?mi)^\\s*(?:\\d{1,2}(?:\\.\\d{1,2}){0,2}[\\)\\.]?\\s*)?POPULATION(?:\\s+CIBLE)?\\b"
      - "(?mi)^\\s*(?:\\d{1,2}[\\. \\t]*)?POPULATION(?:\\s+CIBLE)?\\b"
      - "(?mi)^\\s*(?:\\d{1,2}[\\. \\t]*)?PATIENTS?\\s+CONCERN[ÉE]S?\\b"

      # 2) Fließtext-Patterns
      - "(?mi)\\bPOPULATION\\s+CIBLE\\b"
      - "(?mi)\\bpopulation\\s+cible\\b"
      
      # 3) Meta-Aussagen (SMOFKABIVEN, VABYSMO)
      - "(?mi)\\bla\\s+population\\s+cible\\b"
      - "(?mi)\\bpopulation\\s+cible\\s+d[ée]j[àa]\\s+estim[ée]e?s?\\b"
      - "(?mi)\\bpopulation\\s+cible\\s+de\\s+cette\\s+sp[ée]cialit[ée]\\s+ne\\s+peut\\s+[êe]tre\\s+estim[ée]e?\\b"
      # FIX: n[''] statt n['']
      - "(?mi)\\bn['']est pas de nature [àa] modifier les populations cibles\\b"

  Subpopulation:
    min_chars: 20  # Angepasst an MIN_SUBPOP_CHARS im Code
    max_length: 800
    patterns:
      - "(?mi)^(?:\\d{1,2}[\\. \\t]*)?SOUS-?POPULATION(S)?\\b"
      - "(?mi)^(?:\\d{1,2}[\\. \\t]*)?SOUS-?GROUPE(S)?\\b"
      - "(?mi)\\banalyses?\\s+en\\s+sous-?groupe\\b"
      - "(?mi)\\br[ée]sultats?\\s+dans\\s+le\\s+sous-?groupe\\b"

  Comparateur:
    min_chars: 80
    max_length: 1000
    patterns:
      # Überschrift-Varianten für den Comparator-Block
      - "(?mi)^(?:\\d{1,2}[\\. \\t]*)?COMPARATEURS?\\s+CLINIQUEMENT\\s+PERTINENTS\\b"
      - "(?mi)^(?:\\d{1,2}[\\. \\t]*)?COMPARATEURS?\\b"
      - "(?mi)^(?:\\d{1,2}[\\. \\t]*)?M[ÉE]DICAMENTS?\\s+DE\\s+COMPARAISON\\b"

      # Fließtext-Fallback
      - "(?mi)\\bcomparateurs?\\s+cliniquement\\s+pertinents?\\b"

  Synthese:
    min_chars: 150
    max_length: 6000
    patterns:
     # S1: Neues AVIS Layout (höchste Priorität)
     - rule_id: synthese_avis_section
       start: '(?i)synth[èe]se\s+de\s+l[''']avis'
       end: '^\s*[0-9]+[\).]\s*(?:Contexte|Indication|M[ée]thode)'
       min_chars: 300
    
     # S3: Klassische CONCLUSIONS DE LA COMMISSION (Standard)
      - rule_id: conclusions_commission
        start: '(?mi)^\s*(?:\d{1,2}[\s.]*)?CONCLUSIONS?\s+DE\s+LA\s+COMMISSION(?:\s+DE\s+LA\s+TRANSPARENCE)?\b'
        end: '(?:^\s*(?:\d{1,2}[\s.]*)?(?:RECOMMANDATIONS?|ANNEXE|Programme|Bibliographie)|\Z)'
        min_chars: 150
    
    # S6: PIC_REEV Compte tenu / En conséquence
    - rule_id: compte_tenu_consequence
      start: 'Compte\s+tenu\s*:'
      end: '(?:En\s+conséquence|Ainsi|Par\s+cons[ée]quent).*?[.!]'
      min_chars: 200
    
    # Fallback 1: Einfache CONCLUSIONS
    - rule_id: conclusions_simple
      start: '(?mi)^\s*(?:\d{1,2}[\s.]*)?CONCLUSIONS?\b'
      end: '(?:^\s*(?:\d{1,2}[\s.]*)?[A-Z]{4,}|\Z)'
      min_chars: 150
    
    # Fallback 2: SYNTHÈSE allgemein
    - rule_id: synthese_general
      start: '(?mi)^\s*(?:\d{1,2}[\s.]*)?SYNTH[ÈE]SE\b'
      end: '(?:^\s*(?:\d{1,2}[\s.]*)?[A-Z]{4,}|\Z)'
      min_chars: 150
    
    # Fallback 3: L'ESSENTIEL (4-Seiten-Avis)
    - rule_id: lessentiel
      start: '(?mi)^\s*L[''']ESSENTIEL\b'
      end: '(?:Quel\s+progr[èe]s|^\s*[0-9]+[\s.])'
      min_chars: 100
    
    # Fallback 4: AVIS/POSITION DE LA COMMISSION
    - rule_id: avis_commission
      start: '(?mi)^\s*(?:\d{1,2}[\s.]*)?(?:AVIS|POSITION)\s+DE\s+LA\s+COMMISSION\b'
      end: '(?:^\s*(?:\d{1,2}[\s.]*)?[A-Z]{4,}|\Z)'
      min_chars: 150
